#!/usr/bin/env ruby

case ARGV[0]
when "-v"
  require 'pry-try'
  puts PryTry::VERSION
  exit
end

VERSION_LIKE_RE = [Gem::Requirement::PATTERN, /v?\d+\.\d+/, /^\h+$/].freeze

def parse_args(args)
  args.each_with_object([]) do |arg, obj|
    matches_arg = arg.method(:match).to_proc
    if VERSION_LIKE_RE.detect(&matches_arg)
      obj[-1] << arg
    else
      obj << [arg]
    end
  end
end

REQUIREMENTS = {
  'rails' => %w(rails/all active_support/all),
  'activerecord' => %w(active_record),
  'activesupport' => %w(active_support/all),
}.freeze

@gems = parse_args(ARGV).map do |gem|
  if r = REQUIREMENTS[gem.first]
    gem << {:require => r}
  else
    gem
  end
end

if @gems.any?
  require 'tempfile'
  require 'yaml'
  @script = Tempfile.new.tap do |f|
    File.write(f, <<CODEZ.gsub(/\n+ *(?=\S)/, ';'))
require 'bundler/inline'
require 'yaml'

gemfile(true) do
  source 'https://rubygems.org'
  gem 'pry'
  YAML.load(#{YAML.dump(@gems).inspect}).each {|gargs| gem(*gargs) }
end;nil
CODEZ
  end
end

 exec %{unset BUNDLE_BIN;script=$(cat #{@script ? @script.path : ''} #{$stdin.tty? ? '' : '-'}; echo;echo '$stdin = $stdin.reopen "/dev/tty";'); printf "${script}" | pry}
